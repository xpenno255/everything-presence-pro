esphome:
  on_boot: 
    priority: -100
    then:
      - button.press: get_mmwave_firmware
      - binary_sensor.template.publish:
          id: ld2450_zone1_occupancy
          state: false 
      - binary_sensor.template.publish:
          id: ld2450_zone2_occupancy
          state: false 
      - binary_sensor.template.publish:
          id: ld2450_zone3_occupancy
          state: false 
      - binary_sensor.template.publish:
          id: ld2450_zone4_occupancy
          state: false

globals:
  - id: mmwave_update_time
    type: unsigned long
    restore_value: False
    initial_value: '0'
  - id: mmwave_update_interval
    type: unsigned long
    restore_value: False
    initial_value: '250'
  - id: target1_last_update
    type: unsigned long
    initial_value: '0'
    restore_value: False
  - id: entities_update_count
    type: unsigned int
    restore_value: False
    initial_value: '0'
  - id: entities_update_max_count
    type: unsigned int
    restore_value: False
    initial_value: '0'
  - id: extra_entities
    type: unsigned int
    restore_value: False
    initial_value: '0'
  - id: last_zone_hold
    type: int
    restore_value: False
    initial_value: '0'
  - id: poly_initialized
    type: bool
    restore_value: False
    initial_value: 'false'


interval:
  - interval: 1s
    then:
      - lambda: |-
          if (id(ld2450_stale_reset).state && id(extra_entities) >= 3) {
            unsigned long now = millis();
            unsigned long timeout_ms = (unsigned long)(id(ld2450_stale_timeout).state * 1000);
            if ((now - id(target1_last_update)) > timeout_ms && id(ld2450_target1_active).state == true) {
              ESP_LOGD("LD2450", "Stale target, clearing");
              id(reboot_ld2450_sensor).press();
              id(target1_last_update) = now + 3000; //Prevent another reset for at least 3s
            }
          }

text_sensor:
  - platform: template
    disabled_by_default: True
    name: "Tracking Sensor Firmware"
    id: "ld2450_firmware"
    entity_category: diagnostic

button:
  - platform: template
    id: get_mmwave_firmware
    internal: True
    entity_category: config
    disabled_by_default: True
    on_press: 
      then:
      - switch.turn_on: ld2450_configuration
      - delay: 1s
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x02, 0x00, 0xA0, 0x00, 0x04, 0x03, 0x02, 0x01]
      - lambda: |-
          uint8_t response[20];
          if (id(uart_bus).read_array(response, 20)) {
            int firmware_major = response[13];
            int firmware_minor = response[12];
            char firmware_version_str[32];
            sprintf(firmware_version_str, "V%d.%02d", firmware_major, firmware_minor);
            id(ld2450_firmware).publish_state(std::string(firmware_version_str));
          } else {
            id(ld2450_firmware).publish_state("Unknown");
          }
      - switch.turn_off: ld2450_configuration
      - delay: 1s
  - platform: template
    name: "Reboot Tracking Sensor"
    id: reboot_ld2450_sensor
    disabled_by_default: True
    entity_category: config
    on_press:
      then:
      - switch.turn_on: ld2450_configuration
      - delay: 1s  
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x02, 0x00, 0xA3, 0x00, 0x04, 0x03, 0x02, 0x01]
  - platform: template
    name: "Factory Reset Tracking Sensor"
    id: factory_reset_ld2450_sensor
    disabled_by_default: True
    entity_category: config
    on_press:
      then:
      - logger.log: "Performing Factory Reset"
      - switch.turn_on: ld2450_configuration
      - delay: 2s
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x02, 0x00, 0xA2, 0x00, 0x04, 0x03, 0x02, 0x01]
      - delay: 2s
      - switch.turn_off: ld2450_configuration
      - delay: 2s
      - button.press: reboot_ld2450_sensor

switch:
  - platform: template
    name: "Tracking Configuration Mode"
    id: ld2450_configuration
    disabled_by_default: True
    internal: True
    entity_category: config
    optimistic: true
    restore_mode: DISABLED
    turn_on_action:
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x04, 0x00, 0xFF, 0x00, 0x01, 0x00, 0x04, 0x03, 0x02, 0x01]
    turn_off_action:
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x02, 0x00, 0xFE, 0x00, 0x04, 0x03, 0x02, 0x01]

  - platform: template
    name: "LD2450 Bluetooth"
    id: ld2450_bluetooth
    optimistic: true
    disabled_by_default: True
    entity_category: config
    turn_on_action:
      - switch.turn_on: ld2450_configuration
      - delay: 2s
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x04, 0x00, 0xA4, 0x00, 0x01, 0x00, 0x04, 0x03, 0x02, 0x01]
      - delay: 2s
      - button.press: reboot_ld2450_sensor  # Reboot after enabling Bluetooth
      - delay: 2s
      - switch.turn_off: ld2450_configuration

    turn_off_action:
      - switch.turn_on: ld2450_configuration
      - delay: 2s
      - uart.write:
          id: uart_bus
          data: [0xFD, 0xFC, 0xFB, 0xFA, 0x04, 0x00, 0xA4, 0x00, 0x00, 0x00, 0x04, 0x03, 0x02, 0x01]
      - delay: 2s
      - button.press: reboot_ld2450_sensor  # Reboot after enabling Bluetooth
      - delay: 2s
      - switch.turn_off: ld2450_configuration

  - platform: template
    name: "Auto-Clear Stuck Targets"
    id: ld2450_stale_reset
    restore_mode: RESTORE_DEFAULT_OFF 
    optimistic: True
    entity_category: config

  - platform: template
    name: "Enable Assumed Presence"
    id: ld2450_assumed_presence
    restore_mode: RESTORE_DEFAULT_OFF 
    optimistic: True
    entity_category: config

  - platform: template
    name: "Upside Down Mounting"
    id: ld2450_upside_down
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: True
    entity_category: config
    icon: "mdi:rotate-180"

binary_sensor:
  - platform: template
    name: "Tracking Presence"
    device_class: occupancy
    id: ld2450_occupancy
    filters:
      - delayed_off: !lambda return (id(ld2450_off_delay).state * 1000);

  - platform: template
    name: "Zone 1 Presence"
    device_class: occupancy
    id: ld2450_zone1_occupancy
    filters:
      - delayed_off: !lambda return (id(ld2450_zone1_off_delay).state * 1000);
  - platform: template
    name: "Zone 2 Presence"
    device_class: occupancy
    id: ld2450_zone2_occupancy
    filters:
      - delayed_off: !lambda return (id(ld2450_zone2_off_delay).state * 1000);
    disabled_by_default: true
  - platform: template
    name: "Zone 3 Presence"
    device_class: occupancy
    id: ld2450_zone3_occupancy
    filters:
      - delayed_off: !lambda return (id(ld2450_zone3_off_delay).state * 1000);
    disabled_by_default: true
  - platform: template
    name: "Zone 4 Presence"
    device_class: occupancy
    id: ld2450_zone4_occupancy
    filters:
      - delayed_off: !lambda return (id(ld2450_zone4_off_delay).state * 1000);
    disabled_by_default: true

  - platform: template
    name: "Target 1 Active"
    id: ld2450_target1_active
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Active"
    id: ld2450_target2_active
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Active"
    id: ld2450_target3_active
    entity_category: diagnostic
  - platform: template
    name: "Assumed Present"
    id: assumed_present
    entity_category: diagnostic

number:
  - platform: template
    name: "Tracking Presence Timeout"
    id: ld2450_off_delay
    max_value: 600
    min_value: 0
    step: 1
    optimistic: True
    restore_value: True
    unit_of_measurement: "s"
    initial_value: 15
    entity_category: config
  - platform: template
    name: "Tracking Detection Range"
    id: ld2450_max_distance
    entity_category: config
    max_value: 600
    min_value: 0
    unit_of_measurement: "cm"
    step: 1
    optimistic: True
    restore_value: True
    initial_value: 600
  - platform: template
    name: "Tracking Sensor Angle"
    id: ld2450_installation_angle
    entity_category: config
    unit_of_measurement: "º"
    min_value: -45
    max_value: 45
    step: 1
    update_interval: never
    optimistic: true
    restore_value: true
    initial_value: 0
    icon: "mdi:angle-acute"

  - platform: template
    name: "Zone 1 Timeout"
    id: ld2450_zone1_off_delay
    entity_category: config
    max_value: 600
    min_value: 0
    step: 1
    optimistic: True
    restore_value: True
    unit_of_measurement: "s"
    initial_value: 15

  - platform: template
    name: "Zone 2 Timeout"
    id: ld2450_zone2_off_delay
    max_value: 600
    min_value: 0
    step: 1
    optimistic: True
    restore_value: True
    unit_of_measurement: "s"
    initial_value: 15
    disabled_by_default: true
    entity_category: config

  - platform: template
    name: "Zone 3 Timeout"
    id: ld2450_zone3_off_delay
    max_value: 600
    min_value: 0
    step: 1
    optimistic: True
    restore_value: True
    unit_of_measurement: "s"
    initial_value: 15
    disabled_by_default: true
    entity_category: config

  - platform: template
    name: "Zone 4 Timeout"
    id: ld2450_zone4_off_delay
    max_value: 600
    min_value: 0
    step: 1
    optimistic: True
    restore_value: True
    unit_of_measurement: "s"
    initial_value: 15
    disabled_by_default: true
    entity_category: config

  - platform: template
    name: "Stuck Target Timeout"
    id: ld2450_stale_timeout
    min_value: 1
    max_value: 60
    step: 1
    unit_of_measurement: "s"
    optimistic: true
    restore_value: true
    initial_value: 3
    entity_category: config

sensor:
  - platform: template
    name: "Target 1 X"
    id: ld2450_target1_x
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 1 Y"
    id: ld2450_target1_y
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 1 Speed"
    id: ld2450_target1_speed
    accuracy_decimals: 2
    unit_of_measurement: 'm/s'
    state_class: measurement
    device_class: speed
    entity_category: diagnostic
  - platform: template
    name: "Target 1 Resolution"
    id: ld2450_target1_resolution
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 2 X"
    id: ld2450_target2_x
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Y"
    id: ld2450_target2_y
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Speed"
    id: ld2450_target2_speed
    accuracy_decimals: 2
    unit_of_measurement: 'm/s'
    state_class: measurement
    device_class: speed
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Resolution"
    id: ld2450_target2_resolution
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 3 X"
    id: ld2450_target3_x
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Y"
    id: ld2450_target3_y
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Speed"
    id: ld2450_target3_speed
    accuracy_decimals: 2
    unit_of_measurement: 'm/s'
    state_class: measurement
    device_class: speed
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Resolution"
    id: ld2450_target3_resolution
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 1 Angle"
    id: ld2450_target1_angle
    accuracy_decimals: 0
    unit_of_measurement: '°'
    state_class: measurement
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Angle"
    id: ld2450_target2_angle
    accuracy_decimals: 0
    unit_of_measurement: '°'
    state_class: measurement
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Angle"
    id: ld2450_target3_angle
    accuracy_decimals: 0
    unit_of_measurement: '°'
    state_class: measurement
    entity_category: diagnostic
  - platform: template
    name: "Target 1 Distance"
    id: ld2450_target1_distance
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 2 Distance"
    id: ld2450_target2_distance
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Target 3 Distance"
    id: ld2450_target3_distance
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    entity_category: diagnostic
  - platform: template
    name: "Zone 1 Target Count"
    id: ld2450_zone1_target_count
    accuracy_decimals: 0
    unit_of_measurement: " "
    entity_category: diagnostic
  - platform: template
    name: "Zone 2 Target Count"
    id: ld2450_zone2_target_count
    accuracy_decimals: 0
    disabled_by_default: true
    unit_of_measurement: " "
    entity_category: diagnostic
  - platform: template
    name: "Zone 3 Target Count"
    id: ld2450_zone3_target_count
    accuracy_decimals: 0
    disabled_by_default: true
    unit_of_measurement: " "
    entity_category: diagnostic
  - platform: template
    name: "Zone 4 Target Count"
    id: ld2450_zone4_target_count
    accuracy_decimals: 0
    disabled_by_default: true
    unit_of_measurement: " "
    entity_category: diagnostic
  - platform: template
    name: "Exclusion Zone 1 Target Count"
    id: ld2450_mask1_target_count
    accuracy_decimals: 0
    disabled_by_default: true
    unit_of_measurement: " "
    entity_category: diagnostic
  - platform: template
    name: "Exclusion Zone 2 Target Count"
    id: ld2450_mask2_target_count
    accuracy_decimals: 0
    disabled_by_default: true
    unit_of_measurement: " "
    entity_category: diagnostic

select:
  - platform: template
    name: 'Update speed'
    icon: 'mdi:speedometer'
    optimistic: true
    restore_value: true
    entity_category: config
    options:
      - Faster (0.1s)
      - Fast (0.2s)
      - Normal (0.3s)
      - Slow (0.4s)
      - Slower (0.5s)
    initial_option: Normal (0.3s)
    on_value:
      then:
        - lambda: id(mmwave_update_interval) = (i + 1) * 100;
  - platform: template
    name: "Target Update Rate"
    icon: 'mdi:update'
    optimistic: true
    restore_value: true
    entity_category: config
    options:
      - Every update
      - Every 2 updates
      - Every 3 updates
      - Every 5 updates
      - Every 10 updates
      - Every 20 updates
    initial_option: Every update
    on_value:
      then:
        - lambda: |-
            switch (i) {
              case 3:
                id(entities_update_max_count) = 5;
                break;
              case 4:
                id(entities_update_max_count) = 10;
                break;
              case 5:
                id(entities_update_max_count) = 20;
                break;
              default:
                id(entities_update_max_count) = i + 1;
            }
  - platform: template
    name: "Target Tracking Detail"
    id: ld2450_tracking_behaviour
    icon: 'mdi:dots-vertical'
    optimistic: true
    restore_value: true
    entity_category: config
    options:
      - None
      - Targets Position 
      - Above + Zone count
      - Above + Targets active
      - Above + Distance and Angle
      - Above + Speed and Resolution
    initial_option: Above + Speed and Resolution
    on_value:
      then:
        - lambda: |-
            id(extra_entities) = i;
            
            if (i < 5) {  // If not using Speed and Resolution
              id(ld2450_target1_speed).publish_state(NAN);
              id(ld2450_target2_speed).publish_state(NAN);
              id(ld2450_target3_speed).publish_state(NAN);
              id(ld2450_target1_resolution).publish_state(NAN);
              id(ld2450_target2_resolution).publish_state(NAN);
              id(ld2450_target3_resolution).publish_state(NAN);
            }
            
            if (i < 4) {  // If not using Distance and Angle
              id(ld2450_target1_distance).publish_state(NAN);
              id(ld2450_target2_distance).publish_state(NAN);
              id(ld2450_target3_distance).publish_state(NAN);
              id(ld2450_target1_angle).publish_state(NAN);
              id(ld2450_target2_angle).publish_state(NAN);
              id(ld2450_target3_angle).publish_state(NAN);
            }
            
            if (i < 3) {  // If not using Targets active
              id(ld2450_target1_active).publish_state(false);
              id(ld2450_target2_active).publish_state(false);
              id(ld2450_target3_active).publish_state(false);
            }
            
            if (i < 2) {  // If not using Zone count
              id(ld2450_zone1_target_count).publish_state(NAN);
              id(ld2450_zone2_target_count).publish_state(NAN);
              id(ld2450_zone3_target_count).publish_state(NAN);
              id(ld2450_zone4_target_count).publish_state(NAN);
              id(ld2450_mask1_target_count).publish_state(NAN);
              id(ld2450_mask2_target_count).publish_state(NAN);
            }
            
            if (i < 1) {  // If using None
              id(ld2450_target1_x).publish_state(NAN);
              id(ld2450_target1_y).publish_state(NAN);
              id(ld2450_target2_x).publish_state(NAN);
              id(ld2450_target2_y).publish_state(NAN);
              id(ld2450_target3_x).publish_state(NAN);
              id(ld2450_target3_y).publish_state(NAN);
            }

text:
  - platform: template
    name: "Polygon Zone 1"
    id: poly_zone_1
    mode: text
    optimistic: true
    restore_value: true
    initial_value: ""
    disabled_by_default: false
    entity_category: config
    icon: "mdi:vector-polygon"
    on_value: 
      globals.set:
        id: poly_initialized
        value: 'false'
  - platform: template
    name: "Polygon Zone 2"
    id: poly_zone_2
    mode: text
    optimistic: true
    restore_value: true
    initial_value: ""
    disabled_by_default: false
    entity_category: config
    icon: "mdi:vector-polygon"
    on_value: 
      globals.set:
        id: poly_initialized
        value: 'false'
  - platform: template
    name: "Polygon Zone 3"
    id: poly_zone_3
    mode: text
    optimistic: true
    restore_value: true
    initial_value: ""
    disabled_by_default: false
    entity_category: config
    icon: "mdi:vector-polygon"
    on_value: 
      globals.set:
        id: poly_initialized
        value: 'false'
  - platform: template
    name: "Polygon Zone 4"
    id: poly_zone_4
    mode: text
    optimistic: true
    restore_value: true
    initial_value: ""
    disabled_by_default: false
    entity_category: config
    icon: "mdi:vector-polygon"
    on_value: 
      globals.set:
        id: poly_initialized
        value: 'false'
  - platform: template
    name: "Polygon Exclusion 1"
    id: poly_exclusion_1
    mode: text
    optimistic: true
    restore_value: true
    initial_value: ""
    disabled_by_default: false
    entity_category: config
    icon: "mdi:vector-polygon"
    on_value: 
      globals.set:
        id: poly_initialized
        value: 'false'
  - platform: template
    name: "Polygon Exclusion 2"
    id: poly_exclusion_2
    mode: text
    optimistic: true
    restore_value: true
    initial_value: ""
    disabled_by_default: false
    entity_category: config
    icon: "mdi:vector-polygon"
    on_value: 
      globals.set:
        id: poly_initialized
        value: 'false'

uart:
  - id: uart_bus
    tx_pin: 
      number: GPIO13
      mode:
        input: true
        pullup: true
    rx_pin: 
      number: GPIO14
      mode:
        input: true
        pullup: true
    baud_rate: 256000
    parity: NONE
    stop_bits: 1
    data_bits: 8
    debug:
      direction: RX
      dummy_receiver: True
      after:
        delimiter: [0X55, 0XCC]
      sequence:
      # - lambda: UARTDebug::log_hex(direction, bytes, ' ');
      - lambda: |-
          unsigned long now = millis();
          if ((now - id(mmwave_update_time)) <= id(mmwave_update_interval)) { 
            return;
          };
          id(mmwave_update_time) = now;

          if (bytes.size() != 30) {
            ESP_LOGW("LD2450", "Expected 30 bytes but received %hu!", bytes.size());
            return;
          }

          bool update_entities = false;
          if(id(extra_entities) != 0) {
            id(entities_update_count) += 1;
            update_entities = id(entities_update_count) >= id(entities_update_max_count);
            if (update_entities) {
              id(entities_update_count) = 0;
            }
          }

          const static float RADIANS_TO_DEGREES = 180.0 / 3.14159265358979323846;
          const static float DEGREES_TO_RADIANS = 3.14159265358979323846 / 180.0;
          const static int16_t MIN_INT16_VAL = -32768;

          float max_distance = float(id(ld2450_max_distance).state) * 10;
          float installation_angle = id(ld2450_installation_angle).state * DEGREES_TO_RADIANS;

          const static int MAX_POLY_VERTICES = 20;

          struct ParsedPolygon {
            float vx[20];
            float vy[20];
            int count;
          };

          static ParsedPolygon poly_zones[4];
          static ParsedPolygon poly_exclusions[2];

          auto parse_polygon_text = [](const std::string& text, ParsedPolygon& poly) {
            poly.count = 0;
            if (text.empty()) return;

            size_t pos = 0;
            while (pos < text.length() && poly.count < 20) {
              int x, y;
              int chars_read;
              if (sscanf(text.c_str() + pos, "%d:%d%n", &x, &y, &chars_read) == 2) {
                poly.vx[poly.count] = (float)x;
                poly.vy[poly.count] = (float)y;
                poly.count++;
                pos += chars_read;
                if (pos < text.length() && text[pos] == ';') pos++;
              } else {
                break;
              }
            }
          };

          auto point_in_poly = [](float px, float py, const ParsedPolygon& poly) -> bool {
            if (poly.count < 3) return false;

            bool inside = false;
            for (int i = 0, j = poly.count - 1; i < poly.count; j = i++) {
              float xi = poly.vx[i], yi = poly.vy[i];
              float xj = poly.vx[j], yj = poly.vy[j];

              if (((yi > py) != (yj > py)) &&
                  (px < (xj - xi) * (py - yi) / (yj - yi) + xi)) {
                inside = !inside;
              }
            }
            return inside;
          };

          if (!id(poly_initialized)) {
            parse_polygon_text(id(poly_zone_1).state, poly_zones[0]);
            parse_polygon_text(id(poly_zone_2).state, poly_zones[1]);
            parse_polygon_text(id(poly_zone_3).state, poly_zones[2]);
            parse_polygon_text(id(poly_zone_4).state, poly_zones[3]);
            parse_polygon_text(id(poly_exclusion_1).state, poly_exclusions[0]);
            parse_polygon_text(id(poly_exclusion_2).state, poly_exclusions[1]);
            id(poly_initialized) = true;
            ESP_LOGD("LD2450", "Init polys");
          }

          // Extracted for consistency of read values
          int zone_counts[] = {0,0,0,0};
          int zone_exclusion_counts[] = {0,0};


          bool p1_detected = *((uint16_t *)(&bytes[10])) != 0;
          bool p2_detected = *((uint16_t *)(&bytes[18])) != 0;
          bool p3_detected = *((uint16_t *)(&bytes[26])) != 0;
          bool target_masked = false;

          if (p1_detected) {
            int16_t p1_x = *((int16_t *)(&bytes[4]));
            if (p1_x < 0) p1_x += MIN_INT16_VAL;
            else p1_x = -p1_x;

            int16_t p1_y = *((int16_t *)(&bytes[6]));
            if (p1_y < 0) p1_y += MIN_INT16_VAL;
            else p1_y = -p1_y;

            float p1_distance = sqrt(p1_x * p1_x + p1_y * p1_y);
            
            if (!id(ld2450_upside_down).state) {
              p1_x = -p1_x;
            }
            
            if (p1_distance > max_distance) {
              p1_detected = false;
            } else {
              float p1_angle;
              if (installation_angle != 0 || (update_entities && id(extra_entities) >= 4)) {
                p1_angle = atan2(p1_y, p1_x);
              }
              if (installation_angle != 0) {
                float angle = p1_angle - installation_angle;
                p1_x = p1_distance * cos(angle);
                p1_y = p1_distance * sin(angle);
              }
              if (point_in_poly(p1_x, p1_y, poly_exclusions[0])) {
                zone_exclusion_counts[0]++;
                p1_detected = false;
                target_masked = true;
              } else if (point_in_poly(p1_x, p1_y, poly_exclusions[1])) {
                zone_exclusion_counts[1]++;
                p1_detected = false;
                target_masked = true;
              } else {
                if (point_in_poly(p1_x, p1_y, poly_zones[0])) { zone_counts[0]++; id(last_zone_hold) = 1; }
                if (point_in_poly(p1_x, p1_y, poly_zones[1])) { zone_counts[1]++; id(last_zone_hold) = 2; }
                if (point_in_poly(p1_x, p1_y, poly_zones[2])) { zone_counts[2]++; id(last_zone_hold) = 3; }
                if (point_in_poly(p1_x, p1_y, poly_zones[3])) { zone_counts[3]++; id(last_zone_hold) = 4; }
              }
              if (update_entities) {
                switch (id(extra_entities)) {
                  case 5:
                    {
                      uint16_t p1_resolution = *((uint16_t *)(&bytes[10]));
                      int16_t p1_speed = *((int16_t *)(&bytes[8]));
                      if (p1_speed < 0) p1_speed += MIN_INT16_VAL;
                      else p1_speed = -p1_speed;
                      float p1_speed_float = p1_speed / 100.0;

                      if (id(ld2450_target1_speed).state != p1_speed_float) {
                        id(ld2450_target1_speed).publish_state(p1_speed_float);
                      }
                      if (id(ld2450_target1_resolution).state != p1_resolution) {
                        id(ld2450_target1_resolution).publish_state(p1_resolution);
                      }
                    }
                  case 4:
                    p1_angle = (p1_angle * RADIANS_TO_DEGREES) - 90;

                    if (id(ld2450_target1_angle).state != p1_angle) {
                      id(ld2450_target1_angle).publish_state(p1_angle);
                    }
                    if (id(ld2450_target1_distance).state != p1_distance) {
                      id(ld2450_target1_distance).publish_state(p1_distance);
                    }
                  case 3:
                    id(ld2450_target1_active).publish_state(true);
                  case 2:
                  case 1:
                    if (id(ld2450_target1_x).state != p1_x || id(ld2450_target1_y).state != p1_y) {
                      id(ld2450_target1_x).publish_state(p1_x);
                      id(ld2450_target1_y).publish_state(p1_y);
                      id(target1_last_update) = now;
                    }
                }
              }
            }
          }

          if (update_entities && !p1_detected && !target_masked) {
            switch (id(extra_entities)) {
              case 5:
                if (id(ld2450_target1_speed).state != 0) {
                id(ld2450_target1_speed).publish_state(0);
                }
                if (id(ld2450_target1_resolution).state != 0) {
                  id(ld2450_target1_resolution).publish_state(0);
                }
              case 4:
                if (id(ld2450_target1_distance).state != 0) {
                  id(ld2450_target1_distance).publish_state(0);
                }
                if (id(ld2450_target1_angle).state != 0) {
                  id(ld2450_target1_angle).publish_state(0);
                }
              case 3:
                id(ld2450_target1_active).publish_state(false);
              case 2:
              case 1:
                if (id(ld2450_target1_x).state != 0 || id(ld2450_target1_y).state != 0) {
                  id(ld2450_target1_x).publish_state(0);
                  id(ld2450_target1_y).publish_state(0);
                }
            }
          }

          target_masked = false;

          if (p2_detected) {
            int16_t p2_x = *((int16_t *)(&bytes[12]));
            if (p2_x < 0) p2_x += MIN_INT16_VAL;
            else p2_x = -p2_x;

            int16_t p2_y = *((int16_t *)(&bytes[14]));
            if (p2_y < 0) p2_y += MIN_INT16_VAL;
            else p2_y = -p2_y;

            float p2_distance = sqrt(p2_x * p2_x + p2_y * p2_y);
            
            if (!id(ld2450_upside_down).state) {
              p2_x = -p2_x;
            }
            
            if (p2_distance > max_distance) {
              p2_detected = false;
            } else {
              float p2_angle;
              if (installation_angle != 0 || (update_entities && id(extra_entities) >= 4)) {
                p2_angle = atan2(p2_y, p2_x);
              }
              if (installation_angle != 0) {
                float angle = p2_angle - installation_angle;
                p2_x = p2_distance * cos(angle);
                p2_y = p2_distance * sin(angle);
              }
              if (point_in_poly(p2_x, p2_y, poly_exclusions[0])) {
                zone_exclusion_counts[0]++;
                p2_detected = false;
                target_masked = true;
              } else if (point_in_poly(p2_x, p2_y, poly_exclusions[1])) {
                zone_exclusion_counts[1]++;
                p2_detected = false;
                target_masked = true;
              } else {
                if (point_in_poly(p2_x, p2_y, poly_zones[0])) { zone_counts[0]++; id(last_zone_hold) = 1; }
                if (point_in_poly(p2_x, p2_y, poly_zones[1])) { zone_counts[1]++; id(last_zone_hold) = 2; }
                if (point_in_poly(p2_x, p2_y, poly_zones[2])) { zone_counts[2]++; id(last_zone_hold) = 3; }
                if (point_in_poly(p2_x, p2_y, poly_zones[3])) { zone_counts[3]++; id(last_zone_hold) = 4; }
              }
              if (update_entities) {
                switch (id(extra_entities)) {
                  case 5:
                    {
                      uint16_t p2_resolution = *((uint16_t *)(&bytes[18]));
                      int16_t p2_speed = *((int16_t *)(&bytes[16]));
                      if (p2_speed < 0) p2_speed += MIN_INT16_VAL;
                      else p2_speed = -p2_speed;
                      float p2_speed_float = p2_speed / 100.0;

                      if (id(ld2450_target2_speed).state != p2_speed_float) {
                        id(ld2450_target2_speed).publish_state(p2_speed_float);
                      }
                      if (id(ld2450_target2_resolution).state != p2_resolution) {
                        id(ld2450_target2_resolution).publish_state(p2_resolution);
                      }
                    }
                  case 4:
                    p2_angle = (p2_angle * RADIANS_TO_DEGREES) - 90;

                    if (id(ld2450_target2_angle).state != p2_angle) {
                      id(ld2450_target2_angle).publish_state(p2_angle);
                    }
                    if (id(ld2450_target2_distance).state != p2_distance) {
                      id(ld2450_target2_distance).publish_state(p2_distance);
                    }
                  case 3:
                    id(ld2450_target2_active).publish_state(true);
                  case 2:
                  case 1:
                    if (id(ld2450_target2_x).state != p2_x || id(ld2450_target2_y).state != p2_y) {
                      id(ld2450_target2_x).publish_state(p2_x);
                      id(ld2450_target2_y).publish_state(p2_y);
                    }
                }
              }
            }
          }

          if (update_entities && !p2_detected && !target_masked) {
            switch (id(extra_entities)) {
              case 5:
                if (id(ld2450_target2_speed).state != 0) {
                  id(ld2450_target2_speed).publish_state(0);
                }
                if (id(ld2450_target2_resolution).state != 0) {
                  id(ld2450_target2_resolution).publish_state(0);
                }
              case 4:
                if (id(ld2450_target2_distance).state != 0) {
                  id(ld2450_target2_distance).publish_state(0);
                }
                if (id(ld2450_target2_angle).state != 0) {
                  id(ld2450_target2_angle).publish_state(0);
                }
              case 3:
                id(ld2450_target2_active).publish_state(false);
              case 2:
              case 1:
                if (id(ld2450_target2_x).state != 0 || id(ld2450_target2_y).state != 0) {
                  id(ld2450_target2_x).publish_state(0);
                  id(ld2450_target2_y).publish_state(0);
                }
            }
          }

          target_masked = false;

          if (p3_detected) {
            int16_t p3_x = *((int16_t *)(&bytes[20]));
            if (p3_x < 0) p3_x += MIN_INT16_VAL;
            else p3_x = -p3_x;

            int16_t p3_y = *((int16_t *)(&bytes[22]));
            if (p3_y < 0) p3_y += MIN_INT16_VAL;
            else p3_y = -p3_y;

            float p3_distance = sqrt(p3_x * p3_x + p3_y * p3_y);
            
            if (!id(ld2450_upside_down).state) {
              p3_x = -p3_x;
            }
            
            if (p3_distance > max_distance) {
              p3_detected = false;
            } else {
              float p3_angle;
              if (installation_angle != 0 || (update_entities && id(extra_entities) >= 4)) {
                p3_angle = atan2(p3_y, p3_x);
              }
              if (installation_angle != 0) {
                float angle = p3_angle - installation_angle;
                p3_x = p3_distance * cos(angle);
                p3_y = p3_distance * sin(angle);
              }
              if (point_in_poly(p3_x, p3_y, poly_exclusions[0])) {
                zone_exclusion_counts[0]++;
                p3_detected = false;
                target_masked = true;
              } else if (point_in_poly(p3_x, p3_y, poly_exclusions[1])) {
                zone_exclusion_counts[1]++;
                p3_detected = false;
                target_masked = true;
              } else {
                if (point_in_poly(p3_x, p3_y, poly_zones[0])) { zone_counts[0]++; id(last_zone_hold) = 1; }
                if (point_in_poly(p3_x, p3_y, poly_zones[1])) { zone_counts[1]++; id(last_zone_hold) = 2; }
                if (point_in_poly(p3_x, p3_y, poly_zones[2])) { zone_counts[2]++; id(last_zone_hold) = 3; }
                if (point_in_poly(p3_x, p3_y, poly_zones[3])) { zone_counts[3]++; id(last_zone_hold) = 4; }
              }
              
              if (update_entities) {
                switch (id(extra_entities)) {
                  case 5:
                    {
                      uint16_t p3_resolution = *((uint16_t *)(&bytes[26]));
                      int16_t p3_speed = *((int16_t *)(&bytes[24]));
                      if (p3_speed < 0) p3_speed += MIN_INT16_VAL;
                      else p3_speed = -p3_speed;
                      float p3_speed_float = p3_speed / 100.0;

                      if (id(ld2450_target3_speed).state != p3_speed_float) {
                        id(ld2450_target3_speed).publish_state(p3_speed_float);
                      }
                      if (id(ld2450_target3_resolution).state != p3_resolution) {
                        id(ld2450_target3_resolution).publish_state(p3_resolution);
                      }
                    }
                  case 4:
                    p3_angle = (p3_angle * RADIANS_TO_DEGREES) - 90;
                    
                    if (id(ld2450_target3_angle).state != p3_angle) {
                      id(ld2450_target3_angle).publish_state(p3_angle);
                    }
                    if (id(ld2450_target3_distance).state != p3_distance) {
                      id(ld2450_target3_distance).publish_state(p3_distance);
                    }
                  case 3:
                    id(ld2450_target3_active).publish_state(true);
                  case 2:
                  case 1:
                    if (id(ld2450_target3_x).state != p3_x || id(ld2450_target3_y).state != p3_y) {
                      id(ld2450_target3_x).publish_state(p3_x);
                      id(ld2450_target3_y).publish_state(p3_y);
                    }
                }
              }
            }
          }

          if (update_entities && !p3_detected && !target_masked) {
            switch (id(extra_entities)) {
              case 5:
                if (id(ld2450_target3_speed).state != 0) {
                  id(ld2450_target3_speed).publish_state(0);
                }
                if (id(ld2450_target3_resolution).state != 0) {
                  id(ld2450_target3_resolution).publish_state(0);
                }
              case 4:
                if (id(ld2450_target3_distance).state != 0) {
                  id(ld2450_target3_distance).publish_state(0);
                }
                if (id(ld2450_target3_angle).state != 0) {
                  id(ld2450_target3_angle).publish_state(0);
                }
              case 3:
                id(ld2450_target3_active).publish_state(false);
              case 2:
              case 1:
                if (id(ld2450_target3_x).state != 0 || id(ld2450_target3_y).state != 0) {
                  id(ld2450_target3_x).publish_state(0);
                  id(ld2450_target3_y).publish_state(0);
                }
            }
          }

          if (update_entities && id(extra_entities) >= 2) {
            if (id(ld2450_zone1_target_count).state != zone_counts[0]) {
              id(ld2450_zone1_target_count).publish_state(zone_counts[0]);
            }
            if (id(ld2450_zone2_target_count).state != zone_counts[1]) {
              id(ld2450_zone2_target_count).publish_state(zone_counts[1]);
            }
            if (id(ld2450_zone3_target_count).state != zone_counts[2]) {
              id(ld2450_zone3_target_count).publish_state(zone_counts[2]);
            }
            if (id(ld2450_zone4_target_count).state != zone_counts[3]) {
              id(ld2450_zone4_target_count).publish_state(zone_counts[3]);
            }
            if (id(ld2450_mask1_target_count).state != zone_exclusion_counts[0]) {
              id(ld2450_mask1_target_count).publish_state(zone_exclusion_counts[0]);
            }
            if (id(ld2450_mask2_target_count).state != zone_exclusion_counts[1]) {
              id(ld2450_mask2_target_count).publish_state(zone_exclusion_counts[1]);
            }
          }

          if(id(last_zone_hold) != 0 && (!id(ld2450_assumed_presence).state || id(dfrobot_presence).state == false)) {
            id(last_zone_hold) = 0;
          }
          bool any_detected = p1_detected || p2_detected || p3_detected;
          id(assumed_present).publish_state(!any_detected && id(last_zone_hold) != 0);
          id(ld2450_occupancy).publish_state(any_detected || id(last_zone_hold) != 0);

          id(ld2450_zone1_occupancy).publish_state(zone_counts[0] > 0 || id(last_zone_hold) == 1);
          id(ld2450_zone2_occupancy).publish_state(zone_counts[1] > 0 || id(last_zone_hold) == 2);
          id(ld2450_zone3_occupancy).publish_state(zone_counts[2] > 0 || id(last_zone_hold) == 3);
          id(ld2450_zone4_occupancy).publish_state(zone_counts[3] > 0 || id(last_zone_hold) == 4);