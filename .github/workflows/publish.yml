name: Build and Publish ESPHome firmware

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
    paths:
      - '**.yaml'

permissions:
  contents: write
  pages: write

jobs:
  # Ethernet variants
  publish-epp-ethernet:
    name: Publish Everything Presence Pro Ethernet
    uses: EverythingSmartHome/everything-presence-lite/.github/workflows/esphome-build.yml@main
    secrets: inherit
    with:
      files: everything-presence-pro-ethernet.yaml
      name: Everything Presence Pro Ethernet
      manifest_filename: everything-presence-pro-ethernet-manifest.json
      clean: false
      esphome_version: latest
      directory_name: everything-presence-pro-ethernet

  publish-epp-ethernet-ble:
    name: Publish Everything Presence Pro Ethernet BLE
    uses: EverythingSmartHome/everything-presence-lite/.github/workflows/esphome-build.yml@main
    secrets: inherit
    with:
      files: everything-presence-pro-ethernet-ble.yaml
      name: Everything Presence Pro Ethernet BLE
      manifest_filename: everything-presence-pro-ethernet-ble-manifest.json
      clean: false
      esphome_version: latest
      directory_name: everything-presence-pro-ethernet-ble

  publish-epp-ethernet-co2:
    name: Publish Everything Presence Pro Ethernet CO₂
    uses: EverythingSmartHome/everything-presence-lite/.github/workflows/esphome-build.yml@main
    secrets: inherit
    with:
      files: everything-presence-pro-ethernet-co2.yaml
      name: Everything Presence Pro Ethernet CO₂
      manifest_filename: everything-presence-pro-ethernet-co2-manifest.json
      clean: false
      esphome_version: latest
      directory_name: everything-presence-pro-ethernet-co2

  publish-epp-ethernet-ble-co2:
    name: Publish Everything Presence Pro Ethernet BLE CO₂
    uses: EverythingSmartHome/everything-presence-lite/.github/workflows/esphome-build.yml@main
    secrets: inherit
    with:
      files: everything-presence-pro-ethernet-ble-co2.yaml
      name: Everything Presence Pro Ethernet BLE CO₂
      manifest_filename: everything-presence-pro-ethernet-ble-co2-manifest.json
      clean: false
      esphome_version: latest
      directory_name: everything-presence-pro-ethernet-ble-co2

  # WiFi variants
  publish-epp-wifi:
    name: Publish Everything Presence Pro WiFi
    uses: EverythingSmartHome/everything-presence-lite/.github/workflows/esphome-build.yml@main
    secrets: inherit
    with:
      files: everything-presence-pro-wifi.yaml
      name: Everything Presence Pro WiFi
      manifest_filename: everything-presence-pro-wifi-manifest.json
      clean: false
      esphome_version: latest
      directory_name: everything-presence-pro-wifi

  publish-epp-wifi-ble:
    name: Publish Everything Presence Pro WiFi BLE
    uses: EverythingSmartHome/everything-presence-lite/.github/workflows/esphome-build.yml@main
    secrets: inherit
    with:
      files: everything-presence-pro-wifi-ble.yaml
      name: Everything Presence Pro WiFi BLE
      manifest_filename: everything-presence-pro-wifi-ble-manifest.json
      clean: false
      esphome_version: latest
      directory_name: everything-presence-pro-wifi-ble

  publish-epp-wifi-co2:
    name: Publish Everything Presence Pro WiFi CO₂
    uses: EverythingSmartHome/everything-presence-lite/.github/workflows/esphome-build.yml@main
    secrets: inherit
    with:
      files: everything-presence-pro-wifi-co2.yaml
      name: Everything Presence Pro WiFi CO₂
      manifest_filename: everything-presence-pro-wifi-co2-manifest.json
      clean: false
      esphome_version: latest
      directory_name: everything-presence-pro-wifi-co2

  publish-epp-wifi-ble-co2:
    name: Publish Everything Presence Pro WiFi BLE CO₂
    uses: EverythingSmartHome/everything-presence-lite/.github/workflows/esphome-build.yml@main
    secrets: inherit
    with:
      files: everything-presence-pro-wifi-ble-co2.yaml
      name: Everything Presence Pro WiFi BLE CO₂
      manifest_filename: everything-presence-pro-wifi-ble-co2-manifest.json
      clean: false
      esphome_version: latest
      directory_name: everything-presence-pro-wifi-ble-co2

  # Generate firmware index after all builds complete
  generate-firmware-index:
    name: Generate Firmware Index
    runs-on: ubuntu-latest
    needs:
      - publish-epp-ethernet
      - publish-epp-ethernet-ble
      - publish-epp-ethernet-co2
      - publish-epp-ethernet-ble-co2
      - publish-epp-wifi
      - publish-epp-wifi-ble
      - publish-epp-wifi-co2
      - publish-epp-wifi-ble-co2
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from esphome project
        id: version
        run: |
          VERSION=$(grep -m1 'version:' common/everything-presence-pro-base.yaml | sed 's/.*version: *//' | tr -d '"' | tr -d "'")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Generate firmware index
        run: |
          node scripts/generate-firmware-index.js --version "${{ steps.version.outputs.version }}"

      - name: Deploy firmware index to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: .
          target-folder: /
          clean: false
          single-commit: false
          commit-message: "Update firmware-index.json for v${{ steps.version.outputs.version }}"

  add-release-notes:
    name: Add Release Notes to Manifests
    runs-on: ubuntu-latest
    needs:
      - generate-firmware-index
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from firmware index
        id: version
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('firmware-index.json', 'utf8'));
          const version = data?.product?.latestVersion || data?.firmwares?.[0]?.version || '';
          if (!version) {
            throw new Error('Could not determine version from firmware-index.json');
          }
          console.log(`Detected version: ${version}`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `version=${version}\n`);
          NODE

      - name: Patch manifests with release notes
        env:
          RELEASE_SUMMARY: "Breaking change: Polygon zones only + automatic migration"
          RELEASE_URL: "https://github.com/EverythingSmartHome/everything-presence-pro/releases/tag/v${{ steps.version.outputs.version }}"
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const root = process.cwd();
          const summary = process.env.RELEASE_SUMMARY;
          const releaseUrl = process.env.RELEASE_URL;

          const isJson = (p) => p.endsWith('.json');
          const walk = (dir) => {
            const out = [];
            for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
              const full = path.join(dir, entry.name);
              if (entry.isDirectory()) out.push(...walk(full));
              else if (entry.isFile() && isJson(full)) out.push(full);
            }
            return out;
          };

          const files = walk(root);
          let updated = 0;

          for (const file of files) {
            let data;
            try {
              data = JSON.parse(fs.readFileSync(file, 'utf8'));
            } catch {
              continue;
            }

            let touched = false;
            if (Array.isArray(data.builds)) {
              data.builds = data.builds.map((build) => {
                if (build && build.ota && typeof build.ota === 'object') {
                  build.ota.summary = summary;
                  build.ota.release_url = releaseUrl;
                  touched = true;
                }
                return build;
              });
            }

            if (data.ota && typeof data.ota === 'object') {
              data.ota.summary = summary;
              data.ota.release_url = releaseUrl;
              touched = true;
            }

            if (touched) {
              fs.writeFileSync(file, JSON.stringify(data, null, 2));
              updated += 1;
            }
          }

          console.log(`Updated ${updated} manifest files`);
          NODE

      - name: Deploy updated manifests to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: .
          target-folder: /
          clean: false
          single-commit: false
          commit-message: "Add release notes for v${{ steps.version.outputs.version }}"
